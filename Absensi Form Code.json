{"files":[{"id":"0ad4c3c1-7f1e-43ca-8b79-91b6d8dcf1ba","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Jakarta\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"b62c97a9-983b-4867-9b09-09bcf81622c5","name":"Kode","type":"server_js","source":"/*\n * ABSENSI GOOGLE SCRIPT\n */\nvar idGambarLogo \u003d \u002716Uk0jU6lhxCPGP7yNtU21lHV4Bx49YMD\u0027; // id file logo di Google Drive\nvar idDataPegawai \u003d \u00271AWtEDCoIznBvtZQaWoQZiScDImBthDCSKQ0Qj9p6y3w\u0027; // id file spreadsheet pegawai\nvar idDataAbsensi \u003d \u002714Sd2XOXc-n3UxGu7yaxbkzoGrLyafIFTe49-i6dZXtQ\u0027; // id file spreadsheet absensi\nvar namaPerusahaan \u003d \u0027\u0027; // Nama perusahaan\nvar lokasiPerusahaan \u003d [-5.144204, 119.527934]; // Koordinat [lat, lon]\nvar jarakMaxWFO \u003d 0.5; // Maksimum jarak WFO dalam km\nvar jarakMaxWFH \u003d 50000; // Maksimum jarak WFH dalam km\n\nfunction doGet() {\n  let templateIndex \u003d HtmlService.createTemplateFromFile(\u0027index\u0027);\n  templateIndex.dt \u003d {\n    logo: getImage(idGambarLogo),\n    perusahaan: namaPerusahaan,\n  };\n  return templateIndex\n    .evaluate()\n    .setSandboxMode(HtmlService.SandboxMode.IFRAME)\n    .addMetaTag(\u0027viewport\u0027, \u0027width\u003ddevice-width, initial-scale\u003d1\u0027);\n}\n\nfunction getCurrentTime() {\n  const timeZone \u003d SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();\n  const currentDate \u003d new Date();\n  return Utilities.formatDate(currentDate, timeZone, \u0027dd/MM/yyyy HH:mm:ss\u0027);\n}\n\nclass Absensi {\n  constructor(dt) {\n    this.dt \u003d dt;\n    this.dt.idPegawai \u003d this.dt.idPegawai ? this.dt.idPegawai.toString() : \u0027\u0027;\n    this.dt.password \u003d this.dt.password ? this.dt.password.toString() : \u0027\u0027;\n    this.dt.kegiatan \u003d this.dt.kegiatan ? this.dt.kegiatan.toString() : \u0027\u0027;\n    this.dt.absensi \u003d this.dt.absensi ? this.dt.absensi.toString() : \u0027\u0027;\n    this.dt.workFrom \u003d this.dt.workFrom ? this.dt.workFrom.toString() : \u0027\u0027;\n    this.dt.position \u003d this.dt.position ? this.dt.position : [0, 0];\n\n    let pegawaiSheet \u003d SpreadsheetApp.openById(idDataPegawai).getSheetByName(\u0027Pegawai\u0027);\n    this.userList \u003d pegawaiSheet.getDataRange().getValues();\n    this.indexUser \u003d -1;\n  }\n\n  validUser() {\n    let idList \u003d this.userList.map(row \u003d\u003e row[1].toString().toUpperCase());\n    let passwordList \u003d this.userList.map(row \u003d\u003e row[4].toString());\n    this.indexUser \u003d idList.indexOf(this.dt.idPegawai.toUpperCase());\n    return this.indexUser \u003e\u003d 0 \u0026\u0026 passwordList[this.indexUser] \u003d\u003d\u003d this.dt.password;\n  }\n\n  validDistance() {\n    if (this.dt.position[0] \u003d\u003d\u003d 0 \u0026\u0026 this.dt.position[1] \u003d\u003d\u003d 0) {\n      return \u0027Lokasi Anda tidak terekam.\u0027;\n    } else {\n      this.distance \u003d this.calculateDistance(\n        lokasiPerusahaan[0],\n        lokasiPerusahaan[1],\n        this.dt.position[0],\n        this.dt.position[1]\n      );\n      if (this.dt.workFrom \u003d\u003d\u003d \u0027WFO\u0027 \u0026\u0026 this.distance \u003e jarakMaxWFO) {\n        return `Lokasi terlalu jauh: ${this.distance.toFixed(2)} km dari perusahaan. Maksimal ${jarakMaxWFO} km.`;\n      }\n      if (this.dt.workFrom \u003d\u003d\u003d \u0027WFH\u0027 \u0026\u0026 this.distance \u003e jarakMaxWFH) {\n        return `Lokasi terlalu jauh: ${this.distance.toFixed(2)} km. Maksimal ${jarakMaxWFH} km.`;\n      }\n      return \u0027confirm\u0027;\n    }\n  }\n\n  calculateDistance(lat1, lon1, lat2, lon2) {\n    const R \u003d 6371; // Radius bumi dalam km\n    const dLat \u003d this.degToRad(lat2 - lat1);\n    const dLon \u003d this.degToRad(lon2 - lon1);\n    const a \u003d\n      Math.sin(dLat / 2) * Math.sin(dLat / 2) +\n      Math.cos(this.degToRad(lat1)) *\n        Math.cos(this.degToRad(lat2)) *\n        Math.sin(dLon / 2) *\n        Math.sin(dLon / 2);\n    const c \u003d 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    return R * c;\n  }\n\n  degToRad(deg) {\n    return deg * (Math.PI / 180);\n  }\n\n  saveAbsensi() {\n    let absensiSheet \u003d SpreadsheetApp.openById(idDataAbsensi).getSheetByName(\u0027Absensi\u0027);\n    let user \u003d this.userList[this.indexUser];\n    let location \u003d Maps.newGeocoder()\n      .reverseGeocode(this.dt.position[0], this.dt.position[1])\n      .results[0].formatted_address;\n\n    absensiSheet.appendRow([\n      new Date(),\n      user[1],\n      user[2],\n      user[3],\n      this.dt.absensi,\n      this.dt.workFrom,\n      this.dt.kegiatan,\n      this.distance,\n      `${this.dt.position[0]},${this.dt.position[1]}`,\n      location,\n    ]);\n    return user[2];\n  }\n}\n\nfunction submitAbsensi(dt) {\n  let absensi \u003d new Absensi(dt);\n  let result \u003d { success: false, msg: \u0027\u0027 };\n\n  // Cek validitas pengguna\n  if (!absensi.validUser()) {\n    result.msg \u003d \u0027Pengguna tidak terdaftar atau kata sandi salah.\u0027;\n    return result;\n  }\n\n  // Dapatkan waktu saat ini\n  const currentTime \u003d new Date();\n  const currentHour \u003d currentTime.getHours();\n\n  // Pembatasan waktu absensi\n  if (currentHour \u003e\u003d 6 \u0026\u0026 currentHour \u003c 12 \u0026\u0026 absensi.dt.absensi \u003d\u003d\u003d \u0027Pulang\u0027) {\n    result.msg \u003d \u0027Maap sekarang bukan waktunya absen pulang\u0027;\n    return result;\n  }\n  if (currentHour \u003e\u003d 12 \u0026\u0026 currentHour \u003c 17 \u0026\u0026 absensi.dt.absensi \u003d\u003d\u003d \u0027Masuk\u0027) {\n    result.msg \u003d \u0027Maap sekarang bukan waktunya absen masuk\u0027;\n    return result;\n  }\n  if (currentHour \u003c 6 || currentHour \u003e\u003d 17) {\n    result.msg \u003d \u0027Maap sekarang bukan waktunya absen ngantor\u0027;\n    return result;\n  }\n\n  // Validasi jarak lokasi\n  let distanceValidation \u003d absensi.validDistance();\n  if (distanceValidation !\u003d\u003d \u0027confirm\u0027) {\n    result.msg \u003d distanceValidation;\n    return result;\n  }\n\n  // Simpan absensi jika semua validasi lolos\n  result.msg \u003d absensi.saveAbsensi();\n  result.success \u003d true;\n  result.redirect \u003d true; // Set redirect menjadi true setelah absensi disimpan\n  return result;\n}\n\n// Pada sisi HTML atau JavaScript front-end:\n// Tangani respons untuk mengarahkan pengguna ke halaman lain atau menyembunyikan formulir\nfunction handleResponse(response) {\n  if (response.success \u0026\u0026 response.redirect) {\n    document.getElementById(\u0027form-absensi\u0027).style.display \u003d \u0027none\u0027; // Sembunyikan formulir\n  } else {\n    alert(response.msg); // Tampilkan pesan kesalahan jika ada\n  }\n}"},{"id":"fc680b4f-6538-4f95-b78b-b0b5adffb145","name":"index","type":"html","source":"\u003c!DOCTYPE html\u003e\n\u003chtml\u003e\n\n\u003chead\u003e\n    \u003cbase target\u003d\"_top\"\u003e\n    \u003cmeta name\u003d\"viewport\" content\u003d\"width\u003ddevice-width, initial-scale\u003d1\"\u003e\n    \u003clink rel\u003d\"stylesheet\" href\u003d\"https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css\"\u003e\n    \u003clink rel\u003d\"stylesheet\" href\u003d\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css\"\u003e\n    \u003cstyle\u003e\n        body {\n            background: linear-gradient(to right, #6a11cb, #2575fc);\n            color: #fff;\n        }\n\n        .form-container {\n            background-color: #fff;\n            color: #000;\n            border-radius: 10px;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);\n            padding: 20px;\n        }\n\n        .btn-primary {\n            background: #6a11cb;\n            border: none;\n            transition: background-color 0.3s ease;\n        }\n\n        .btn-primary:hover {\n            background: #2575fc;\n        }\n\n        .alert {\n            border-radius: 5px;\n        }\n\n        footer {\n            color: #dcdcdc;\n        }\n    \u003c/style\u003e\n\u003c/head\u003e\n\n\u003cbody\u003e\n    \u003cdiv class\u003d\"container mt-5\"\u003e\n        \u003cdiv class\u003d\"card text-center bg-light mb-4\"\u003e\n            \u003cdiv class\u003d\"card-body\"\u003e\n                \u003cimg src\u003d\"data:image/png;base64, \u003c?!\u003ddt.logo?\u003e\" alt\u003d\"Logo\" width\u003d\"150\" class\u003d\"mb-3\"\u003e\n                \u003ch2 class\u003d\"card-title\"\u003e\u003c?!\u003ddt.perusahaan?\u003e\u003c/h2\u003e\n            \u003c/div\u003e\n        \u003c/div\u003e\n\n        \u003cdiv class\u003d\"form-container\"\u003e\n            \u003ch4 class\u003d\"text-center mb-4\"\u003eForm Absensi\u003c/h4\u003e\n            \u003cform onsubmit\u003d\"submitAbsensi();return false;\"\u003e\n                \u003cdiv class\u003d\"form-group\"\u003e\n                    \u003clabel for\u003d\"idPegawai\"\u003eID Pegawai\u003c/label\u003e\n                    \u003cinput type\u003d\"text\" class\u003d\"form-control\" id\u003d\"idPegawai\" placeholder\u003d\"Masukkan ID Anda\" required\u003e\n                \u003c/div\u003e\n          \u003cdiv class\u003d\"form-group\"\u003e\n              \u003clabel for\u003d\"password\"\u003ePassword\u003c/label\u003e\n              \u003cdiv class\u003d\"input-group\"\u003e\n                  \u003cinput type\u003d\"password\" class\u003d\"form-control\" id\u003d\"password\" placeholder\u003d\"Masukkan password Anda\" required\u003e\n                  \u003cdiv class\u003d\"input-group-append\"\u003e\n                      \u003cbutton class\u003d\"btn1 btn-outline-secondary\" type\u003d\"button\" id\u003d\"togglePassword\"\u003e\n                          \u003ci class\u003d\"fa fa-eye-slash\"\u003e\u003c/i\u003e\n                      \u003c/button\u003e\n                  \u003c/div\u003e\n              \u003c/div\u003e\n          \u003c/div\u003e\n                \u003cdiv class\u003d\"form-group\"\u003e\n                    \u003clabel\u003eAbsensi\u003c/label\u003e\n                    \u003cdiv class\u003d\"form-check\"\u003e\n                        \u003cinput class\u003d\"form-check-input\" type\u003d\"radio\" name\u003d\"absensi\" id\u003d\"absensi1\" value\u003d\"Masuk\" required\u003e\n                        \u003clabel class\u003d\"form-check-label\" for\u003d\"absensi1\"\u003eMasuk\u003c/label\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class\u003d\"form-check\"\u003e\n                        \u003cinput class\u003d\"form-check-input\" type\u003d\"radio\" name\u003d\"absensi\" id\u003d\"absensi2\" value\u003d\"Pulang\"\u003e\n                        \u003clabel class\u003d\"form-check-label\" for\u003d\"absensi2\"\u003ePulang\u003c/label\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cdiv class\u003d\"form-group\"\u003e\n                    \u003clabel\u003eBekerja dari\u003c/label\u003e\n                    \u003cdiv class\u003d\"form-check\"\u003e\n                        \u003cinput class\u003d\"form-check-input\" type\u003d\"radio\" name\u003d\"workFrom\" id\u003d\"workFrom1\" value\u003d\"WFO\" required\u003e\n                        \u003clabel class\u003d\"form-check-label\" for\u003d\"workFrom1\"\u003eWFO (Kantor)\u003c/label\u003e\n                    \u003c/div\u003e\n                    \u003cdiv class\u003d\"form-check\"\u003e\n                        \u003cinput class\u003d\"form-check-input\" type\u003d\"radio\" name\u003d\"workFrom\" id\u003d\"workFrom2\" value\u003d\"WFH\"\u003e\n                        \u003clabel class\u003d\"form-check-label\" for\u003d\"workFrom2\"\u003eWFH (Rumah)\u003c/label\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n                \u003cdiv class\u003d\"form-group\"\u003e\n                    \u003clabel for\u003d\"kegiatan\"\u003eKegiatan Harian\u003c/label\u003e\n                    \u003ctextarea class\u003d\"form-control\" id\u003d\"kegiatan\" placeholder\u003d\"Diisi hanya saat pulang\" rows\u003d\"4\"\u003e\u003c/textarea\u003e\n                \u003c/div\u003e\n                \u003cdiv class\u003d\"alert alert-success\" role\u003d\"alert\" style\u003d\"display:none\"\u003e\u003c/div\u003e\n                \u003cdiv class\u003d\"alert alert-warning\" role\u003d\"alert\" style\u003d\"display:none\"\u003e\n                    \u003ch5\u003ePerhatian!\u003c/h5\u003e\n                    \u003cp\u003eAnda harus mengizinkan akses lokasi pada browser agar bisa melakukan absensi\u003c/p\u003e\n                \u003c/div\u003e\n                \u003cbutton class\u003d\"btn btn-primary btn-lg btn-block\" type\u003d\"submit\"\u003eSimpan Absensi\u003c/button\u003e\n            \u003c/form\u003e\n        \u003c/div\u003e\n\n        \u003cfooter class\u003d\"my-5 text-center\"\u003e\n            \u003cp class\u003d\"mb-1\"\u003e\u0026copy; Konsultan Edu\u003c/p\u003e\n        \u003c/footer\u003e\n    \u003c/div\u003e\n    \u003cscript\u003e\n        document.getElementById(\u0027togglePassword\u0027).addEventListener(\u0027click\u0027, function () {\n            const passwordField \u003d document.getElementById(\u0027password\u0027);\n            const passwordToggle \u003d this.querySelector(\u0027i\u0027);\n\n            if (passwordField.type \u003d\u003d\u003d \u0027password\u0027) {\n                passwordField.type \u003d \u0027text\u0027;\n                passwordToggle.classList.remove(\u0027fa-eye-slash\u0027);\n                passwordToggle.classList.add(\u0027fa-eye\u0027);\n            } else {\n                passwordField.type \u003d \u0027password\u0027;\n                passwordToggle.classList.remove(\u0027fa-eye\u0027);\n                passwordToggle.classList.add(\u0027fa-eye-slash\u0027);\n            }\n        });\n    \u003c/script\u003e\n\n    \u003cscript src\u003d\"https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js\"\u003e\u003c/script\u003e\n    \u003cscript src\u003d\"//cdn.jsdelivr.net/npm/sweetalert2@10\"\u003e\u003c/script\u003e\n    \u003cscript\u003e\n        function submitAbsensi() {\n            $(\u0027.alert-warning\u0027).show();\n            if (navigator.geolocation)\n                navigator.geolocation.getCurrentPosition(simpanDataAbsensi);\n        }\n        function simpanDataAbsensi(position) {\n            $(\u0027.alert\u0027).hide();\n\n            let data \u003d {\n                idPegawai: $(\u0027#idPegawai\u0027).val(),\n                password: $(\u0027#password\u0027).val(),\n                kegiatan: $(\u0027#kegiatan\u0027).val(),\n                absensi: $(\u0027input[name\u003dabsensi]:checked\u0027, \u0027form\u0027).val(),\n                workFrom: $(\u0027input[name\u003dworkFrom]:checked\u0027, \u0027form\u0027).val(),\n                position: [\n                    position.coords.latitude,\n                    position.coords.longitude\n                ]\n            };\n\n            if (data.absensi \u003d\u003d \u0027Pulang\u0027 \u0026\u0026 data.kegiatan.length \u003c 1) {\n                Swal.fire({\n                    title: \u0027Error!\u0027,\n                    text: \u0027Anda belum mengisi kegiatan harian.\u0027,\n                    icon: \u0027error\u0027,\n                    confirmButtonText: \u0027OK\u0027\n                });\n            } else {\n                $(\u0027.btn\u0027).attr(\u0027disabled\u0027, true).html(\u0027Menyimpan...\u0027);\n                google.script.run.withSuccessHandler(callbackAbsensi).submitAbsensi(data);\n            }\n        }\n        function callbackAbsensi(dt) {\n            if (dt.success) {\n                Swal.fire({\n                    title: \u0027Sukses!\u0027,\n                    html: \u0027\u003cb\u003eHai, \u0027 + dt.msg + \u0027!\u003c/b\u003e\u003cbr\u003eData absensimu sudah disimpan.\u0027,\n                    icon: \u0027success\u0027,\n                    confirmButtonText: \u0027OK\u0027\n                });\n                $(\u0027.form-control\u0027).val(\u0027\u0027);\n            } else {\n                $(\u0027#password\u0027).val(\u0027\u0027);\n                Swal.fire({\n                    title: \u0027Gagal!\u0027,\n                    html: dt.msg,\n                    icon: \u0027error\u0027,\n                    confirmButtonText: \u0027OK\u0027\n                });\n            }\n            $(\u0027.btn\u0027).removeAttr(\u0027disabled\u0027).html(\u0027Simpan Absensi\u0027);\n        }\n    \u003c/script\u003e\n\u003c/body\u003e\n\u003c/html\u003e\n"}]}